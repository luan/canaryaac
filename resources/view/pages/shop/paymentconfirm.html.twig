<div id="webshop" class="Box">
	<div class="Corner-tl" style="background-image:url({{IMAGE_PATH}}/global/content/corner-tl.gif);"></div>
	<div class="Corner-tr" style="background-image:url({{IMAGE_PATH}}/global/content/corner-tr.gif);"></div>
	<div class="Border_1" style="background-image:url({{IMAGE_PATH}}/global/content/border-1.gif);"></div>
	<div class="BorderTitleText" style="background-image:url({{IMAGE_PATH}}/global/content/title-background-green.gif);"></div><img id="ContentBoxHeadline" class="Title" src="{{IMAGE_PATH}}/global/strings/headline-webshop.gif" alt="Contentbox headline">
	<div class="Border_2">
		<div class="Border_3">
			<div class="BoxContent" style="background-image:url({{IMAGE_PATH}}/global/content/scroll.gif);">
				<script type="text/javascript">
					g_Deactivated = true;
				</script>
				<div id="ProgressBar">
					<div id="MainContainer">
						<div id="BackgroundContainer">
							<img id="BackgroundContainerLeftEnd" src="{{IMAGE_PATH}}/global/content/stonebar-left-end.gif">
							<div id="BackgroundContainerCenter">
								<div id="BackgroundContainerCenterImage" style="background-image:url({{IMAGE_PATH}}/global/content/stonebar-center.gif);"></div>
							</div>
							<img id="BackgroundContainerRightEnd" src="{{IMAGE_PATH}}/global/content/stonebar-right-end.gif">
						</div>
						<img id="TubeLeftEnd" src="{{IMAGE_PATH}}/global/content/progressbar/progress-bar-tube-left-green.gif">
						<img id="TubeRightEnd" src="{{IMAGE_PATH}}/global/content/progressbar/progress-bar-tube-right-blue.gif">
						<div id="FirstStep" class="Steps">
							<div class="SingleStepContainer">
								<img class="StepIcon" src="{{IMAGE_PATH}}/global/content/progressbar/progress-bar-icon-1-green.gif">
								<div class="StepText" style="font-weight:normal;">Select product</div>
							</div>
						</div>
						<div id="StepsContainer1">
							<div id="StepsContainer2">
								<div class="Steps" style="width:33%">
									<div class="TubeContainer">
										<img class="Tube" src="{{IMAGE_PATH}}/global/content/progressbar/progress-bar-tube-green.gif">
									</div>
									<div class="SingleStepContainer">
										<img class="StepIcon" src="{{IMAGE_PATH}}/global/content/progressbar/progress-bar-icon-2-green.gif">
										<div class="StepText" style="font-weight:normal;">Enter payment data</div>
									</div>
								</div>
								<div class="Steps" style="width:33%">
									<div class="TubeContainer">
										<img class="Tube" src="{{IMAGE_PATH}}/global/content/progressbar/progress-bar-tube-green.gif">
									</div>
									<div class="SingleStepContainer">
										<img class="StepIcon" src="{{IMAGE_PATH}}/global/content/progressbar/progress-bar-icon-3-green.gif">
										<div class="StepText" style="font-weight:bold;">Confirm your order</div>
									</div>
								</div>
								<div class="Steps" style="width:33%">
									<div class="TubeContainer">
										<img class="Tube" src="{{IMAGE_PATH}}/global/content/progressbar/progress-bar-tube-green-blue.gif">
									</div>
									<div class="SingleStepContainer">
										<img class="StepIcon" src="{{IMAGE_PATH}}/global/content/progressbar/progress-bar-icon-4-blue.gif">
										<div class="StepText" style="font-weight:normal;">Summary</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="CustomerIdentification">Order for:
					<span id="DisplayEMail" onmousedown="ToggleMaskedText('EMail');">********@***.***</span>
					<span id="MaskedEMail">********@***.***</span>
					<span id="ReadableEMail">{{ email }}</span>
					<div><img id="ButtonEMail" onmousedown="ToggleMaskedText('EMail');" src="{{IMAGE_PATH}}/global/general/show.gif"></div>
				</div>
				{% if clientSecret %}
				<form id="payment-form">
				{% else %}
				<form method="post" action="{{URL}}/payment/summary">
				{% endif %}
				<div class="TableContainer">
					<div class="CaptionContainer">
						<div class="CaptionInnerContainer">
							<span class="CaptionEdgeLeftTop" style="background-image:url({{IMAGE_PATH}}/global/content/box-frame-edge.gif);"></span>
							<span class="CaptionEdgeRightTop" style="background-image:url({{IMAGE_PATH}}/global/content/box-frame-edge.gif);"></span>
							<span class="CaptionBorderTop" style="background-image:url({{IMAGE_PATH}}/global/content/table-headline-border.gif);"></span>
							<span class="CaptionVerticalLeft" style="background-image:url({{IMAGE_PATH}}/global/content/box-frame-vertical.gif);"></span>
							<div class="Text">Confirm your order</div>
							<span class="CaptionVerticalRight" style="background-image:url({{IMAGE_PATH}}/global/content/box-frame-vertical.gif);"></span>
							<span class="CaptionBorderBottom" style="background-image:url({{IMAGE_PATH}}/global/content/table-headline-border.gif);"></span>
							<span class="CaptionEdgeLeftBottom" style="background-image:url({{IMAGE_PATH}}/global/content/box-frame-edge.gif);"></span>
							<span class="CaptionEdgeRightBottom" style="background-image:url({{IMAGE_PATH}}/global/content/box-frame-edge.gif);"></span>
						</div>
					</div>
					<table class="Table5" cellpadding="0" cellspacing="0">
						<tbody>
							<tr>
								<td>
									<div class="TableScrollbarWrapper" style="width: unset;">
										<div class="TableScrollbarContainer"></div>
									</div>
									<div class="InnerTableContainer" style="max-width: unset;">
										<table style="width:100%;">
											<tbody>
												<tr>
													<td>
														<div class="TableContentContainer">
															<table class="TableContent" width="100%" style="border:1px solid #faf0d7;">
																<tbody>
																	<tr>
																		<td class="LabelV200">Service</td>
																		<td>{{ coins }} Coins (transferable)</td>
																		<input type="hidden" name="payment_coins" value="{{ coins }}">
																	</tr>
																	<tr>
																		<td class="LabelV200">Price</td>
																		<td>{{ price }} USD</td>
																	</tr>
																</tbody>
															</table>
														</div>
													</td>
												</tr>
												<tr>
													<td>
														<div class="TableContentContainer">
															<table class="TableContent" width="100%" style="border:1px solid #faf0d7;">
																<tbody>
																	<tr>
																		<td class="LabelV200">Payment Method</td>
																		<td>{{ method }}</td>
																		<input type="hidden" name="payment_method" value="{{ method }}">
																	</tr>
																	<tr style="display: none;">
																		<td class="LabelV200">Country:</td>
																		<td>{{ country }}</td>
																		<input type="hidden" name="payment_country" value="{{ country }}">
																	</tr>
																	<tr>
																		<td class="LabelV200">E-Mail Address:</td>
																		<td>{{ email }}</td>
																		<input type="hidden" name="payment_email" value="{{ email }}">
																	</tr>
																	<tr>
																		<td colspan="2">
																			{% if clientSecret %}
																				<div id="payment-element">
																					<!--Stripe.js injects the Payment Element-->
																				</div>
																				<div id="payment-message" class="hidden" style="text-align: center; margin: 8px; font-size: 12pt;"></div>
																			{% endif %}
																		</td>
																	</tr>
																</tbody>
															</table>
														</div>
													</td>
												</tr>
												<tr>
													<td>
														<div class="TableContentContainer">
															<table class="TableContent" width="100%" style="border:1px solid #faf0d7;">
																<tbody>
																	<tr>
																		<td colspan="2">
																			By continuing this order I certify that I have read and I agree to the Extended Tibia Service Agreement and the Tibia Privacy Policy.
																		</td>
																	</tr>
																</tbody>
															</table>
														</div>
													</td>
												</tr>
											</tbody>
										</table>
									</div>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
				<div class="SubmitButtonRow" style="display: flex; justify-content: center;">
					<button id="submit" class="LeftButton" style="padding: 10px;">
						<div class="BigButton" style="background-image:url({{IMAGE_PATH}}/global/buttons/button_green.gif)">
							<div onmouseover="MouseOverBigButton(this);" onmouseout="MouseOutBigButton(this);"><div class="BigButtonOver" style="background-image:url({{IMAGE_PATH}}/global/buttons/button_green_over.gif);"></div>
								<div class="BigButtonText" id="button-text">
									Buy now
								</div>
							</div>
						</div>
					</button>
					<div class="RightButton" style="padding: 10px;">
						<a href="{{URL}}/payment">
							<div class="BigButton" style="background-image:url({{IMAGE_PATH}}/global/buttons/button_blue.gif)">
								<div onmouseover="MouseOverBigButton(this);" onmouseout="MouseOutBigButton(this);"><div class="BigButtonOver" style="background-image:url({{IMAGE_PATH}}/global/buttons/button_blue_over.gif);"></div><input class="BigButtonText" type="button" value="Previous"></div>
							</div>
						</a>
					</div>
				</div>
				</form>
			</div>
		</div>
	</div>
	<div class="Border_1" style="background-image:url({{IMAGE_PATH}}/global/content/border-1.gif);"></div>
	<div class="CornerWrapper-b">
		<div class="Corner-bl" style="background-image:url({{IMAGE_PATH}}/global/content/corner-bl.gif);"></div>
	</div>
	<div class="CornerWrapper-b">
		<div class="Corner-br" style="background-image:url({{IMAGE_PATH}}/global/content/corner-br.gif);"></div>
	</div>
</div>

<script src="https://js.stripe.com/v3/"></script>

<script>
// This is your test publishable API key.
const stripe = Stripe("{{STRIPE_PUBLIC_KEY}}");

// The items the customer wants to buy
const items = [{ id: "xl-tshirt" }];

let elements;

initialize();
async function initialize() {
  elements = stripe.elements({ clientSecret: "{{ clientSecret }}", appearance: {
		theme: "flat",
		  variables: {
				colorPrimary: '#007000',
				colorBackground: '#ffffff',
				colorText: '#5A2800',
				colorDanger: '#df1b41',
				fontFamily: 'Verdana, Arial, Times New Roman, sans-serif',
				fontSizeBase: '10pt',
				spacingUnit: '2px',
				borderRadius: '2px',
			}
	} });

  const paymentElementOptions = {
    layout: "tabs",
  };

  const paymentElement = elements.create("payment", paymentElementOptions);
  paymentElement.mount("#payment-element");
}

document
  .querySelector("#payment-form")
  .addEventListener("submit", handleSubmit);

async function handleSubmit(e) {
  e.preventDefault();
  setLoading(true);

  const { error } = await stripe.confirmPayment({
    elements,
    confirmParams: {
      return_url: "{{URL}}/payment/stripe/return",
    },
  });

  // This point will only be reached if there is an immediate error when
  // confirming the payment. Otherwise, your customer will be redirected to
  // your `return_url`. For some payment methods like iDEAL, your customer will
  // be redirected to an intermediate site first to authorize the payment, then
  // redirected to the `return_url`.
  if (error.type === "card_error" || error.type === "validation_error") {
    showMessage(error.message);
  } else {
    showMessage("An unexpected error occurred.");
  }

  setLoading(false);
}

// ------- UI helpers -------

function showMessage(messageText) {
  const messageContainer = document.querySelector("#payment-message");

  messageContainer.classList.remove("hidden");
  messageContainer.textContent = messageText;

  setTimeout(function () {
    messageContainer.classList.add("hidden");
    messageText.textContent = "";
  }, 4000);
}

// Show a spinner on payment submission
function setLoading(isLoading) {
  if (isLoading) {
    // Disable the button and show a spinner
    document.querySelector("#submit").disabled = true;
    document.querySelector("#button-text").innerHTML = 'Processing...'
  } else {
    document.querySelector("#submit").disabled = false;
    document.querySelector("#button-text").innerHTML = 'Pay now'
  }
}
</script>